"use strict";(self["webpackChunkpvp"]=self["webpackChunkpvp"]||[]).push([[865],{19140:function(e,t,n){n.d(t,{c:function(){return bt}});var o=n(66760),a=n(98752);const s={class:"c-comment-order"},i={class:"u-label"},l={class:"c-comment-pages"},r={class:"u-pages"};function m(e,t,n,m,c,d){const u=(0,o.E1)("CommentInputForm"),p=(0,o.E1)("el-radio-button"),h=(0,o.E1)("el-radio-group"),y=(0,o.E1)("CommentAvatar"),g=(0,o.E1)("CommentWithReply"),f=(0,o.E1)("el-pagination"),w=(0,o.E1)("el-main"),C=(0,o.E1)("el-container"),b=(0,o.iS)("loading");return(0,o.wt)(((0,o.Wz)(),(0,o.Az)(C,{class:"c-comment"},{default:(0,o.Ql)((()=>[(0,o.K2)(w,null,{default:(0,o.Ql)((()=>[(0,o.K2)(u,{onSubmit:d.userSubmitInputForm},null,8,["onSubmit"]),(0,o.QD)("div",s,[(0,o.QD)("span",i,(0,a.WA)(e.$t("排序模式：")),1),(0,o.K2)(h,{modelValue:e.isDesc,"onUpdate:modelValue":t[0]||(t[0]=t=>e.isDesc=t),onChange:d.changeOrder,size:"small"},{default:(0,o.Ql)((()=>[(0,o.K2)(p,{label:"DESC"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("最后靠前")),1)])),_:1}),(0,o.K2)(p,{label:"ASC"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("最早靠前")),1)])),_:1})])),_:1},8,["modelValue","onChange"])]),d.isNormal?((0,o.Wz)(),(0,o.An)(o.ae,{key:0},[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(e.commentList,(t=>((0,o.Wz)(),(0,o.An)("div",{key:t.id,class:"c-comment-list"},[(0,o.K2)(y,{"user-avatar":d.showAvatar(t.avatar),"user-href":d.profileLink(t.userId),username:t.displayName,avatarFrame:t.user_avatar_frame,withFrame:!0,avatarSize:48},null,8,["user-avatar","user-href","username","avatarFrame"]),(0,o.K2)(g,{"base-api":e.baseAPI,item:t,category:n.category,power:e.commentPower,onDeleteComment:d.deleteComment,onSetTopComment:d.setTopComment,onSetStarComment:d.setStarComment,"user-href":d.profileLink(t.userId),username:t.displayName},null,8,["base-api","item","category","power","onDeleteComment","onSetTopComment","onSetStarComment","user-href","username"])])))),128)),(0,o.QD)("div",l,[e.commentList.length>5?((0,o.Wz)(),(0,o.Az)(u,{key:0,onSubmit:d.userSubmitInputForm,isBottom:e.commentList.length>5},null,8,["onSubmit","isBottom"])):(0,o.g1)("",!0),(0,o.QD)("div",r,[(0,o.K2)(f,{style:{"text-align":"right"},background:"","hide-on-single-page":"",onCurrentChange:d.handleCurrentChange,"current-page":e.pager.index,"page-size":e.pager.pageSize,layout:"prev, pager, next, total",total:e.pager.total},null,8,["onCurrentChange","current-page","page-size","total"])])])],64)):(0,o.g1)("",!0)])),_:1})])),_:1})),[[b,e.loading]])}var c=n(35440);const d={class:"c-comment-avatar"},u=["href"],p=["src"];function h(e,t,n,s,i,l){const r=(0,o.E1)("el-avatar"),m=(0,o.E1)("el-link");return(0,o.Wz)(),(0,o.An)("div",d,[(0,o.QD)("a",{class:"u-avatar",href:n.userHref,target:"_blank"},[(0,o.K2)(r,{class:(0,a.WN)(["u-avatar-pic",36==n.avatarSize?"xxs":""]),shape:"circle",size:n.avatarSize,src:n.userAvatar},null,8,["class","size","src"]),n.avatarFrame?((0,o.Wz)(),(0,o.An)("i",{key:0,class:(0,a.WN)(["u-avatar-frame",36==n.avatarSize?"xxs":"xs"])},[(0,o.QD)("img",{src:l.frameUrl},null,8,p)],2)):(0,o.g1)("",!0)],8,u),(0,o.K2)(m,{class:"u-name",type:"primary",target:"_blank",href:n.userHref},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(n.username),1)])),_:1},8,["href"])])}var y=n(79384);const{__imgPath:g}=y;var f={name:"CommentAvatar",props:["avatarSize","userAvatar","userHref","username","avatarFrame","withFrame"],data:function(){return{}},computed:{frameUrl:function(){return g+`avatar/images/${this.avatarFrame}/${this.avatarFrame}.svg`}},methods:{},mounted:function(){}},w=n(18152);const C=(0,w.c)(f,[["render",h]]);var b=C;const v={class:"c-comment-tools"},k={class:"u-toolbar"};function A(e,t,n,s,i,l){const r=(0,o.E1)("el-input"),m=(0,o.E1)("Picture"),c=(0,o.E1)("el-icon"),d=(0,o.E1)("Emotion"),u=(0,o.E1)("Uploader"),p=(0,o.E1)("el-button"),h=(0,o.E1)("el-form-item"),y=(0,o.E1)("el-form");return(0,o.Wz)(),(0,o.Az)(y,{ref:"form",model:e.newComment,class:"c-comment-box"},{default:(0,o.Ql)((()=>[(0,o.K2)(h,null,{default:(0,o.Ql)((()=>[(0,o.K2)(r,{rows:"3",type:"textarea",maxlength:"300","show-word-limit":"",modelValue:e.newComment.content,"onUpdate:modelValue":t[0]||(t[0]=t=>e.newComment.content=t),placeholder:e.$t("参与讨论..."),id:e.inputId},null,8,["modelValue","placeholder","id"]),(0,o.QD)("div",v,[(0,o.K2)(c,{class:"u-upload-icon",onClick:t[1]||(t[1]=t=>e.showUploader=!e.showUploader)},{default:(0,o.Ql)((()=>[(0,o.K2)(m)])),_:1}),(0,o.K2)(d,{class:"c-comment-emotion",onSelected:l.handleEmotionSelected,type:"pop",max:6},null,8,["onSelected"])]),e.showUploader?((0,o.Wz)(),(0,o.Az)(u,{key:0,class:"u-uploader",ref:"uploader",onOnFinish:l.attachmentUploadFinish,onOnError:l.attachmentUploadError},null,8,["onOnFinish","onOnError"])):(0,o.g1)("",!0),(0,o.QD)("div",k,[(0,o.K2)(p,{type:"primary",onClick:l.onSubmit,class:"u-publish",disabled:e.disableSubmitBtn},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("发表评论")),1)])),_:1},8,["onClick","disabled"])])])),_:1})])),_:1},8,["model"])}const S={class:"el-upload__tip"},$=["src"];function E(e,t,n,s,i,l){const r=(0,o.E1)("Plus"),m=(0,o.E1)("el-icon"),c=(0,o.E1)("el-upload"),d=(0,o.E1)("el-dialog");return(0,o.Wz)(),(0,o.An)("div",null,[(0,o.K2)(c,{action:"https://cms.jx3box.com/api/cms/upload",ref:"upload","list-type":"picture-card","on-preview":l.handlePictureCardPreview,"auto-upload":!1,"file-list":i.fileList,limit:i.maxCount,accept:i.acceptedExtensions.reduce(((e,t)=>e+`.${t},`),""),multiple:"","with-credentials":"","on-exceed":l.onExceed,"on-change":l.onChange,"on-success":l.onSuccess,"on-error":l.onError},{tip:(0,o.Ql)((()=>[(0,o.QD)("div",S,(0,a.WA)(e.$t("最多上传")+` ${i.maxCount} `+e.$t("张"))+" "+(0,a.WA)(i.acceptedExtensions.join(" / ").toUpperCase()+e.$t("格式图片，单张图片不能超过"))+" "+(0,a.WA)(i.maxSize/1024/1024)+"MB ",1)])),default:(0,o.Ql)((()=>[(0,o.K2)(m,null,{default:(0,o.Ql)((()=>[(0,o.K2)(r)])),_:1})])),_:1},8,["on-preview","file-list","limit","accept","on-exceed","on-change","on-success","on-error"]),(0,o.K2)(d,{modelValue:i.dialogVisible,"onUpdate:modelValue":t[0]||(t[0]=e=>i.dialogVisible=e)},{default:(0,o.Ql)((()=>[(0,o.QD)("img",{width:"60%",src:i.dialogImageUrl,alt:""},null,8,$)])),_:1},8,["modelValue"])])}var z={name:"CommentUploader",data(){return{dialogImageUrl:"",dialogVisible:!1,fileList:[],successList:[],acceptedExtensions:["jpg","jpeg","png","gif"],maxCount:5,maxSize:2097152}},emits:["onFinish","onError"],methods:{handlePictureCardPreview(e){this.dialogImageUrl=e.url,this.dialogVisible=!0},onExceed(){this.$notify({title:"",message:`最多上传 ${this.maxCount} 张图片！`,type:"error",duration:3e3,position:"bottom-right"})},onChange(e,t){"ready"==e.status&&(e.size>this.maxSize?(this.$notify({title:"",message:`单张图片大小不能超过 ${this.maxSize/1024/1024} MB！`,type:"error",duration:3e3,position:"bottom-right"}),t.pop()):this.fileList=t)},upload(){this.fileList.length>0?this.$refs.upload.submit():this.$emit("onFinish",[])},onSuccess(e){this.successList=this.successList.concat(e.data),this.successList.length==this.fileList.length&&(this.$emit("onFinish",this.successList||[]),this.fileList=[],this.successList=[])},onError(){this.$notify({title:"",message:"图片上传失败!",type:"error",duration:3e3,position:"bottom-right"}),this.$emit("onError"),this.fileList=[]}}};const _=(0,w.c)(z,[["render",E]]);var x=_,R=n.p+"img/emotion.08adf9c0.svg";const W={class:"c-jx3box-emotion"},L=["onClick"],Q=["src","alt","title"],I={class:"c-jx3box-emotion-pop__content"},D={class:"u-title"},F=["src","alt","title"],U={class:"c-jx3box-emotion-list"},P=["onClick"],K=["src","alt","title"],T=(0,o.QD)("img",{slot:"reference",class:"u-reference",width:"24",height:"24",src:R,alt:""},null,-1);function j(e,t,n,s,i,l){const r=(0,o.E1)("el-tab-pane"),m=(0,o.E1)("el-tabs"),c=(0,o.E1)("Close"),d=(0,o.E1)("el-icon"),u=(0,o.E1)("el-popover");return(0,o.Wz)(),(0,o.An)("div",W,["default"===n.type?((0,o.Wz)(),(0,o.Az)(m,{key:0,type:"card"},{default:(0,o.Ql)((()=>[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(l.decorationEmotion,(e=>((0,o.Wz)(),(0,o.Az)(r,{key:e.group_id,label:e.group_name},{default:(0,o.Ql)((()=>[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(e.items,(e=>((0,o.Wz)(),(0,o.An)("span",{key:e.emotion_id,class:"c-jx3box-emotion-item",onClick:t=>l.handleEmotionClick(e)},[(0,o.QD)("img",{src:`${i.EmojiPath}${e.filename}`,alt:e.key,title:e.key},null,8,Q)],8,L)))),128))])),_:2},1032,["label"])))),128))])),_:1})):((0,o.Wz)(),(0,o.Az)(u,{key:1,placement:"top",trigger:"click","visible-arrow":!1,"popper-class":"c-jx3box-emotion-pop",ref:"emotion"},{reference:(0,o.Ql)((()=>[T])),default:(0,o.Ql)((()=>[(0,o.QD)("div",I,[(0,o.K2)(d,{class:"u-close",onClick:l.closePop},{default:(0,o.Ql)((()=>[(0,o.K2)(c)])),_:1},8,["onClick"]),(0,o.QD)("div",D,(0,a.WA)(e.$t("表情")),1),(0,o.K2)(m,{class:"u-tabs",type:"card","tab-position":"bottom",size:"small"},{default:(0,o.Ql)((()=>[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(l.decorationEmotion,(e=>((0,o.Wz)(),(0,o.Az)(r,{key:e.group_id,label:e.group_name},{label:(0,o.Ql)((()=>[(0,o.QD)("img",{src:`${i.EmojiPath}${e.items[0].filename}`,alt:e.items[0].key,title:e.group_name,class:"u-tab-label"},null,8,F)])),default:(0,o.Ql)((()=>[(0,o.QD)("div",U,[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(e.items,(e=>((0,o.Wz)(),(0,o.An)("span",{key:e.emotion_id,class:"c-jx3box-emotion-item",onClick:t=>l.handleEmotionClick(e)},[(0,o.QD)("img",{src:`${i.EmojiPath}${e.filename}`,alt:e.key,title:e.key},null,8,K)],8,P)))),128))])])),_:2},1032,["label"])))),128))])),_:1})])])),_:1},512))])}var Y=n(52774);const{__cms:N}=y,B=e=>{const t=e&&e.domain||N;let n={withCredentials:!0,auth:{username:localStorage&&localStorage.getItem("token")||"",password:"cms common request"},baseURL:t,headers:{}};const o=Y.c.create(n);return o};var O=n(76568);const{__imgPath:V,__dataPath:H}=y;var M={name:"Emotion",props:{type:{type:String,default:"default"},max:{type:Number,default:4}},emits:["selected"],data(){return{emotionList:[],EmojiPath:V+"emotion/output/",decoration:[]}},created(){this.loadEmotionList(),this.loadDecoration()},computed:{decorationEmotion({emotionList:e,decoration:t}){const n=e.filter((e=>0===e.group_id));if(0===t.length)return n;{const o=e.filter((e=>t.includes(e.group_name)));return[...n,...o].slice(0,this.max)}}},methods:{handleEmotionClick(e){this.$emit("selected",e),this.closePop()},loadEmotionList(){try{const e=sessionStorage.getItem("jx3_emotion");if(e)return void(this.emotionList=JSON.parse(e));fetch(`${H}emotion/output/catalog.json`).then((e=>e.json())).then((e=>{this.emotionList=e,sessionStorage.setItem("jx3_emotion",JSON.stringify(e))}))}catch(e){fetch(`${H}emotion/output/catalog.json`).then((e=>e.json())).then((e=>{this.emotionList=e,sessionStorage.setItem("jx3_emotion",JSON.stringify(e))}))}},loadDecoration(){O.c.isLogin()&&B().get("/api/cms/user/decoration",{params:{type:"emotion",using:1}}).then((e=>{this.decoration=e.data?.data?.map((e=>e?.val))}))},closePop(){this.$refs.emotion&&this.$refs.emotion.hide()}}};const J=(0,w.c)(M,[["render",j]]);var q=J,G={components:{Uploader:x,Emotion:q},props:{isBottom:{type:Boolean,default:!1}},mounted(){this.isBottom&&(this.inputId="textarea-bottom")},data:function(){return{showUploader:!1,disableSubmitBtn:!1,newComment:{content:""},inputId:"textarea-top"}},methods:{onSubmit(){this.disableSubmitBtn=!0,this.$refs.uploader?this.$refs.uploader.upload():this.attachmentUploadFinish([])},attachmentUploadFinish(e){this.$emit("submit",{content:this.newComment.content,attachmentList:e}),this.newComment={content:""},this.showUploader=!1,this.disableSubmitBtn=!1},attachmentUploadError(){this.disableSubmitBtn=!1},handleEmotionSelected(e){this.insertVariable(e)},async insertVariable(e){const t=document.querySelector(`#${this.inputId}`),n=e.key;if(t.selectionStart||0===t.selectionStart){let e=t.selectionStart,o=t.selectionEnd;this.newComment.content=t.value.substring(0,e)+n+t.value.substring(o,t.value.length),await this.$nextTick(),t.focus(),t.setSelectionRange(o+n.length,o+n.length)}else this.newComment.content=n}}};const X=(0,w.c)(G,[["render",A]]);var Z=X;const ee={class:"c-comment-cmt"},te={key:0,class:"u-mark u-top"},ne=(0,o.QD)("i",{class:"Download"},null,-1),oe={key:1,class:"u-mark u-star"},ae=(0,o.QD)("i",{class:"Star"},null,-1);function se(e,t,n,s,i,l){const r=(0,o.E1)("el-link"),m=(0,o.E1)("CommentContent"),c=(0,o.E1)("ReplyList");return(0,o.Wz)(),(0,o.An)("div",ee,[(0,o.QD)("div",null,[(0,o.K2)(r,{class:"u-name",type:"primary",target:"_blank",href:e.userHref},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(n.username||e.$t("人字榜800线无名小侠")),1)])),_:1},8,["href"]),n.item.is_top?((0,o.Wz)(),(0,o.An)("span",te,[ne,(0,o.mY)((0,a.WA)(e.$t("置顶")),1)])):(0,o.g1)("",!0),n.item.is_star?((0,o.Wz)(),(0,o.An)("span",oe,[ae,(0,o.mY)((0,a.WA)(e.$t("精华")),1)])):(0,o.g1)("",!0)]),(0,o.K2)(m,{date:n.item.commentDate,content:n.item.content,"comment-id":n.item.id,attachments:l.stringToArray(n.item.attachments),"can-delete":n.power.allow||n.power.uid==n.item.userId,"can-set-top":n.power.is_author&&!n.item.is_top,"can-cancel-top":n.power.is_author&&n.item.is_top,"can-set-star":!n.item.is_star&&n.power.group>=64,"can-cancel-star":n.item.is_star&&n.power.group>=64,onAddNewReply:l.addNewReply,onDeleteComment:l.deleteComment,onSetTopComment:l.setTopComment,onSetStarComment:l.setStarComment},null,8,["date","content","comment-id","attachments","can-delete","can-set-top","can-cancel-top","can-set-star","can-cancel-star","onAddNewReply","onDeleteComment","onSetTopComment","onSetStarComment"]),(0,o.K2)(c,{data:e.replyList,pager:e.pager,power:n.power,onAddNewReply:l.addNewReply,onDeleteReply:l.deleteReply,onGoto:l.gotoReplyListIndex,onResetReply:l.resetReply},null,8,["data","pager","power","onAddNewReply","onDeleteReply","onGoto","onResetReply"])])}const ie={class:"u-cmt"},le=["innerHTML"],re={key:1,class:"u-attachements"},me={class:"u-toolbar"},ce={class:"u-date"},de=(0,o.QD)("i",{class:"Clock"},null,-1),ue={class:"c-comment-tools"};function pe(e,t,n,s,i,l){const r=(0,o.E1)("el-image"),m=(0,o.E1)("el-button"),c=(0,o.E1)("el-input"),d=(0,o.E1)("el-form-item"),u=(0,o.E1)("Picture"),p=(0,o.E1)("el-icon"),h=(0,o.E1)("Emotion"),y=(0,o.E1)("Uploader"),g=(0,o.E1)("el-form");return(0,o.Wz)(),(0,o.An)("div",ie,[""!=n.content?((0,o.Wz)(),(0,o.An)("div",{key:0,class:"u-text",innerHTML:l.formatContent(n.content)},null,8,le)):(0,o.g1)("",!0),n.attachments.length?((0,o.Wz)(),(0,o.An)("div",re,[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(n.attachments,(e=>((0,o.Wz)(),(0,o.Az)(r,{key:e,src:l.showAttachment(e),"preview-src-list":[l.showPreview(e)],lazy:""},null,8,["src","preview-src-list"])))),128))])):(0,o.g1)("",!0),(0,o.QD)("div",me,[(0,o.K2)(m,{class:"u-admin",link:"",size:"small",icon:"ChatRound",onClick:t[0]||(t[0]=t=>e.showForm=!e.showForm),type:"primary"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("回复")),1)])),_:1}),n.canDelete?((0,o.Wz)(),(0,o.Az)(m,{key:0,class:"u-admin",link:"",icon:"Delete",size:"small",onClick:t[1]||(t[1]=e=>l.deleteComment()),type:"danger"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("删除")),1)])),_:1})):(0,o.g1)("",!0),n.canSetTop?((0,o.Wz)(),(0,o.Az)(m,{key:1,class:"u-admin",link:"",icon:"Top",size:"small",onClick:t[2]||(t[2]=e=>l.topComment(!0)),type:"primary"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("置顶")),1)])),_:1})):(0,o.g1)("",!0),n.canCancelTop?((0,o.Wz)(),(0,o.Az)(m,{key:2,class:"u-admin",link:"",icon:"Top",size:"small",onClick:t[3]||(t[3]=e=>l.topComment(!1)),type:"primary"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("取消置顶")),1)])),_:1})):(0,o.g1)("",!0),n.canSetStar?((0,o.Wz)(),(0,o.Az)(m,{key:3,class:"u-admin",link:"",icon:"Star",size:"small",onClick:t[4]||(t[4]=e=>l.starComment(!0)),type:"primary"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("加精")),1)])),_:1})):(0,o.g1)("",!0),n.canCancelStar?((0,o.Wz)(),(0,o.Az)(m,{key:4,class:"u-admin",link:"",icon:"StarFilled",size:"small",onClick:t[5]||(t[5]=e=>l.starComment(!1)),type:"primary"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("取消加精")),1)])),_:1})):(0,o.g1)("",!0),(0,o.QD)("time",ce,[de,(0,o.mY)(" "+(0,a.WA)(l.dataFormat(n.date)),1)])]),e.showForm?((0,o.Wz)(),(0,o.Az)(g,{key:2,ref:"form",model:e.newComment,class:"c-comment-subbox"},{default:(0,o.Ql)((()=>[(0,o.K2)(d,null,{default:(0,o.Ql)((()=>[(0,o.K2)(c,{type:"textarea",modelValue:e.newComment.content,"onUpdate:modelValue":t[6]||(t[6]=t=>e.newComment.content=t),placeholder:e.$("参与评论..."),id:"id"+e.inputId},null,8,["modelValue","placeholder","id"])])),_:1}),(0,o.K2)(d,{class:"c-comment-tool-box"},{default:(0,o.Ql)((()=>[(0,o.QD)("div",ue,[(0,o.K2)(p,{class:"u-upload-icon",onClick:t[7]||(t[7]=t=>e.showUploader=!e.showUploader)},{default:(0,o.Ql)((()=>[(0,o.K2)(u)])),_:1}),(0,o.K2)(h,{class:"c-comment-emotion",onSelected:l.handleEmotionSelected,type:"pop",max:6},null,8,["onSelected"])]),e.showUploader?((0,o.Wz)(),(0,o.Az)(y,{key:0,ref:"uploader",onOnFinish:l.attachmentUploadFinish,onOnError:l.attachmentUplodError},null,8,["onOnFinish","onOnError"])):(0,o.g1)("",!0)])),_:1}),(0,o.K2)(d,null,{default:(0,o.Ql)((()=>[(0,o.K2)(m,{size:"small",type:"primary",onClick:t[8]||(t[8]=e=>l.submit()),disabled:e.disableSubmitBtn},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("提交")),1)])),_:1},8,["disabled"]),(0,o.K2)(m,{size:"small",link:"",onClick:t[9]||(t[9]=t=>e.showForm=!1),type:"primary"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("收起")),1)])),_:1})])),_:1})])),_:1},8,["model"])):(0,o.g1)("",!0)])}var he=n(37588),ye=n.n(he),ge=n(33568);const{__imgPath:fe,__dataPath:we}=y;async function Ce(){const e=sessionStorage.getItem("jx3_emotion");if(e)return JSON.parse(e);{const e=await fetch(`${we}emotion/output/catalog.json`).then((e=>e.json()));return sessionStorage.setItem("jx3_emotion",JSON.stringify(e)),e}}class be{constructor(e){this._joke=ye().trim(e),this.emotionList=[],this.max=0}async loadEmotionList(){const e=await Ce();this.emotionList=e}async _renderHTML(){let e=this._joke;if(!e.includes("#"))return e;for(let t=0;t<3;t++){await this.loadEmotionList();const t=(0,ge.flatMapDeep)(this.emotionList.map((e=>e.items))),n=t.map((e=>e.key));while(n.some((t=>e.includes(t)))){const t=n.findIndex((t=>e.includes(t))),o=n[t].replace("#","$");e=t>-1?e.replace(n[t],o):e}while(n.some((t=>e.includes(`${t.replace("#","$")}`)))){const o=n.findIndex((t=>e.includes(t.replace("#","$")))),a=t.find((e=>e.key===n[o])),s=a?`${fe}emotion/output/${a.filename}`:"",i=n[o].replace("#","$");e=s?e.replace(i,`<img src="${s}" alt="${n[o]}" title="${n[o]}" />`):e}if(this.emotionList.length)break}return e}}var ve=be;function ke(e){const t=new ve(e);return t.code}function Ae(e){return e>9?e:`0${e}`}var Se={props:["content","date","hasReply","canDelete","canSetTop","canCancelTop","canSetStar","canCancelStar","attachments","commentId"],components:{Uploader:x,Emotion:q},data:function(){return{newComment:{content:""},showForm:!1,disableSubmitBtn:!1,showUploader:!1,inputId:"",previewList:[]}},mounted(){this.commentId&&(this.inputId=this.commentId)},computed:{_attachments:function(){return this.attachments.map((e=>(0,c.resolveImagePath)(e)))}},methods:{topComment(e){this.$emit("setTopComment",e)},starComment(e){this.$emit("setStarComment",e)},deleteComment(){this.$confirm("确定删除该评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.$emit("deleteComment")})).catch((()=>{}))},dataFormat(e){let t=new Date(e);return t.getFullYear()+"-"+Ae(t.getMonth()+1)+"-"+Ae(t.getDate())+" "+Ae(t.getHours())+":"+Ae(t.getMinutes())+":"+Ae(t.getSeconds())},attachmentUploadFinish(e){this.disableSubmitBtn=!1,this.$emit("addNewReply",{content:this.newComment.content,attachmentList:e}),this.showUploader=!1,this.newComment={content:""}},attachmentUplodError(){this.disableSubmitBtn=!1},submit(){this.disableSubmitBtn=!0,this.$refs.uploader?this.$refs.uploader.upload():this.attachmentUploadFinish([])},hideForm(){},formatContent:ke,async handleEmotionSelected(e){const t=document.querySelector(`#id${this.inputId}`),n=e.key;if(t.selectionStart||0===t.selectionStart){let e=t.selectionStart,o=t.selectionEnd;this.newComment.content=t.value.substring(0,e)+n+t.value.substring(o,t.value.length),await this.$nextTick(),t.focus(),t.setSelectionRange(o+n.length,o+n.length)}else this.newComment.content=n},showPreview:function(e){return(0,c.resolveImagePath)(e)},showAttachment:function(e){return(0,c.resolveImagePath)(e)+"?x-oss-process=style/comment_thumb"}}};const $e=(0,w.c)(Se,[["render",pe]]);var Ee=$e,ze=n(95328);const _e={key:0,class:"c-comment-replylist"};function xe(e,t,n,s,i,l){const r=(0,o.E1)("reply-item"),m=(0,o.E1)("el-button"),c=(0,o.E1)("el-col"),d=(0,o.E1)("el-pagination"),u=(0,o.E1)("el-row");return n.data.length?((0,o.Wz)(),(0,o.An)("div",_e,[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(n.data,(e=>((0,o.Wz)(),(0,o.Az)(r,{class:"c-comment-reply",key:e.id,reply:e,power:n.power,onDeleteReply:l.deleteReply,onAddReply:l.addReply},null,8,["reply","power","onDeleteReply","onAddReply"])))),128)),n.data.length>=3||e.showPager?((0,o.Wz)(),(0,o.Az)(u,{key:0},{default:(0,o.Ql)((()=>[(0,o.K2)(c,{span:4},{default:(0,o.Ql)((()=>[(0,o.wt)((0,o.K2)(m,{link:"",onClick:t[0]||(t[0]=e=>l.showLess())},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("收起")),1)])),_:1},512),[[ze.Ub,e.showPager]]),(0,o.wt)((0,o.K2)(m,{link:"",onClick:t[1]||(t[1]=e=>l.showMore())},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("查看更多")),1)])),_:1},512),[[ze.Ub,!e.showPager]])])),_:1}),(0,o.K2)(c,{span:20,class:"c-comment-reply-pages"},{default:(0,o.Ql)((()=>[(0,o.wt)((0,o.K2)(d,{small:"",onCurrentChange:l.handleCurrentChange,"current-page":n.pager.index,"page-size":n.pager.pageSize,layout:"total, prev, pager, next",total:n.pager.total},null,8,["onCurrentChange","current-page","page-size","total"]),[[ze.Ub,e.showPager]])])),_:1})])),_:1})):(0,o.g1)("",!0)])):(0,o.g1)("",!0)}function Re(e,t,n,a,s,i){const l=(0,o.E1)("CommentAvatar"),r=(0,o.E1)("CommentContentSimple"),m=(0,o.E1)("ReplyForReply"),c=(0,o.E1)("el-row");return(0,o.Wz)(),(0,o.Az)(c,null,{default:(0,o.Ql)((()=>[(0,o.K2)(l,{"user-avatar":i.showAvatar(n.reply.avatar),"user-href":i.profileLink(n.reply.userId),username:n.reply.displayName,avatarFrame:n.reply.user_avatar_frame,avatarSize:36},null,8,["user-avatar","user-href","username","avatarFrame"]),(0,o.K2)(r,{"comment-id":n.reply.id,date:n.reply.commentDate,content:n.reply.content,attachments:i.stringToArray(n.reply.attachments),"can-delete":n.power.allow||n.power.uid==n.reply.userId,"can-reply":n.power.uid!=n.reply.userId,"user-href":i.profileLink(n.reply.replyForUID),"reply-for-username":n.reply.replyForUsername,"reply-for-user-id":n.reply.replyForUID,onDelete:i.deleteReply,onShowReplyInput:t[0]||(t[0]=t=>e.showReplyForReplyFrom=!e.showReplyForReplyFrom)},null,8,["comment-id","date","content","attachments","can-delete","can-reply","user-href","reply-for-username","reply-for-user-id","onDelete"]),e.showReplyForReplyFrom?((0,o.Wz)(),(0,o.Az)(m,{key:0,username:n.reply.displayName,"user-href":i.profileLink(n.reply.userId),"current-id":n.reply.id,onHideForm:t[1]||(t[1]=t=>e.showReplyForReplyFrom=!1),onDoReply:i.doReply},null,8,["username","user-href","current-id","onDoReply"])):(0,o.g1)("",!0)])),_:1})}const We={class:"u-reply"},Le={class:"u-reply-content"},Qe={key:0,class:"u-reply-label"},Ie=["innerHTML"],De={key:0,class:"u-attachements"},Fe={class:"u-toolbar"},Ue={class:"u-date"},Pe=(0,o.QD)("i",{class:"Clock"},null,-1);function Ke(e,t,n,s,i,l){const r=(0,o.E1)("el-link"),m=(0,o.E1)("el-image"),c=(0,o.E1)("el-button");return(0,o.Wz)(),(0,o.An)("div",We,[(0,o.QD)("div",Le,[0!=n.replyForUserId?((0,o.Wz)(),(0,o.An)("span",Qe,[(0,o.mY)((0,a.WA)(e.$t("回复"))+" ",1),(0,o.K2)(r,{type:"primary",target:"_blank",href:n.userHref},{default:(0,o.Ql)((()=>[(0,o.mY)("@"+(0,a.WA)(n.replyForUsername),1)])),_:1},8,["href"]),(0,o.mY)(" : ")])):(0,o.g1)("",!0),(0,o.QD)("div",{class:"u-reply-text",innerHTML:l.formatContent(n.content)},null,8,Ie)]),n.attachments.length?((0,o.Wz)(),(0,o.An)("div",De,[((0,o.Wz)(!0),(0,o.An)(o.ae,null,(0,o.mi)(n.attachments,(e=>((0,o.Wz)(),(0,o.Az)(m,{key:e,src:l.showAttachment(e),"preview-src-list":[l.showPreview(e)],lazy:""},null,8,["src","preview-src-list"])))),128))])):(0,o.g1)("",!0),(0,o.QD)("div",Fe,[n.canReply?((0,o.Wz)(),(0,o.Az)(c,{key:0,class:"u-admin",link:"",icon:"ChatLineRound",size:"small",onClick:t[0]||(t[0]=e=>l.showReplyForReplyInput()),type:"primary"},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("回复")),1)])),_:1})):(0,o.g1)("",!0),n.canDelete?((0,o.Wz)(),(0,o.Az)(c,{key:1,class:"u-admin",link:"",icon:"Delete",size:"small",type:"danger",onClick:t[1]||(t[1]=e=>l.deleteComment())},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("删除")),1)])),_:1})):(0,o.g1)("",!0),(0,o.QD)("time",Ue,[Pe,(0,o.mY)(" "+(0,a.WA)(l.dataFormat(n.date)),1)])])])}function Te(e){return e>9?e:`0${e}`}var je={props:["commentId","content","attachments","date","hasReply","canDelete","canReply","userHref","replyForUsername","replyForUserId"],data:function(){return{showInput:!1}},computed:{_attachments:function(){return this.attachments.map((e=>(0,c.resolveImagePath)(e)))}},methods:{profileLink:function(e){return(0,c.authorLink)(e)},showAttachment:function(e){return(0,c.resolveImagePath)(e)+"?x-oss-process=style/comment_thumb"},formatContent:ke,getPList(e){return e.split("\n")},deleteComment(){this.$confirm("确定删除该评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.$emit("delete",this.commentId)})).catch((()=>{}))},dataFormat(e){let t=new Date(e);return t.getFullYear()+"-"+Te(t.getMonth()+1)+"-"+Te(t.getDate())+" "+Te(t.getHours())+":"+Te(t.getMinutes())+":"+Te(t.getSeconds())},showReplyForReplyInput(){this.$emit("showReplyInput")},previewImg(e){this.$hevueImgPreview({multiple:!0,nowImgIndex:e,imgList:this._attachments,controlBar:!1,clickMaskCLose:!0})},showPreview:function(e){return(0,c.resolveImagePath)(e)}}};const Ye=(0,w.c)(je,[["render",Ke]]);var Ne=Ye;const Be={class:"u-subbox-label"},Oe={class:"c-comment-tools"};function Ve(e,t,n,s,i,l){const r=(0,o.E1)("el-link"),m=(0,o.E1)("el-input"),c=(0,o.E1)("el-form-item"),d=(0,o.E1)("Picture"),u=(0,o.E1)("el-icon"),p=(0,o.E1)("Uploader"),h=(0,o.E1)("el-button"),y=(0,o.E1)("el-form");return(0,o.Wz)(),(0,o.Az)(y,{ref:"form",class:"c-comment-subbox"},{default:(0,o.Ql)((()=>[(0,o.QD)("div",Be,[(0,o.mY)((0,a.WA)(e.$t("回复"))+" ",1),(0,o.K2)(r,{type:"primary",target:"_blank",href:n.userHref},{default:(0,o.Ql)((()=>[(0,o.mY)("＠"+(0,a.WA)(n.username),1)])),_:1},8,["href"]),(0,o.mY)(" ： ")]),(0,o.K2)(c,null,{default:(0,o.Ql)((()=>[(0,o.K2)(m,{type:"textarea",modelValue:e.content,"onUpdate:modelValue":t[0]||(t[0]=t=>e.content=t),id:"id"+e.inputId,placeholder:e.$t("输入回复...")},null,8,["modelValue","id","placeholder"])])),_:1}),(0,o.K2)(c,null,{default:(0,o.Ql)((()=>[(0,o.QD)("div",Oe,[(0,o.K2)(u,{class:"u-upload-icon",onClick:t[1]||(t[1]=t=>e.showUploader=!e.showUploader)},{default:(0,o.Ql)((()=>[(0,o.K2)(d)])),_:1})]),e.showUploader?((0,o.Wz)(),(0,o.Az)(p,{key:0,ref:"uploader",onOnFinish:l.attachmentUploadFinish,onOnError:l.attachmentUploadError},null,8,["onOnFinish","onOnError"])):(0,o.g1)("",!0)])),_:1}),(0,o.K2)(c,null,{default:(0,o.Ql)((()=>[(0,o.K2)(h,{size:"small",type:"primary",onClick:l.submitReply,disabled:e.disableSubmitBtn},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("提交")),1)])),_:1},8,["onClick","disabled"]),(0,o.K2)(h,{size:"small",link:"",onClick:t[2]||(t[2]=e=>l.hideForm())},{default:(0,o.Ql)((()=>[(0,o.mY)((0,a.WA)(e.$t("收起")),1)])),_:1})])),_:1})])),_:1},512)}var He={props:["username","userHref","currentId"],data:function(){return{content:"",showUploader:!1,disableSubmitBtn:!1,inputId:""}},components:{Uploader:x},mounted(){this.currentId&&(this.inputId=this.currentId)},methods:{submitReply(){this.disableSubmitBtn=!0,this.$refs.uploader?this.$refs.uploader.upload():this.attachmentUploadFinish([])},hideForm(){this.$emit("hideForm")},attachmentUploadFinish(e){this.disableSubmitBtn=!1,this.$emit("doReply",{content:this.content,attachmentList:e}),this.content="",this.showUploader=!1},attachmentUploadError(){this.disableSubmitBtn=!1},async handleEmotionSelected(e){const t=document.querySelector(`#id${this.inputId}`),n=e.key;if(t.selectionStart||0===t.selectionStart){let e=t.selectionStart,o=t.selectionEnd;this.content=t.value.substring(0,e)+n+t.value.substring(o,t.value.length),await this.$nextTick(),t.focus(),t.setSelectionRange(o+n.length,o+n.length)}else this.content=n}}};const Me=(0,w.c)(He,[["render",Ve]]);var Je=Me,qe={props:["reply","power"],components:{CommentAvatar:b,CommentContentSimple:Ne,ReplyForReply:Je},backReplyList:[],data:function(){return{showReplyForReplyFrom:!1}},methods:{profileLink:function(e){return(0,c.authorLink)(e)},stringToArray:function(e){return e?JSON.parse(e):[]},showAvatar:function(e){return(0,c.showAvatar)(e,84)},deleteReply(e){this.$emit("deleteReply",e)},doReply(e){e.replyForUID=this.reply.userId,e.replyForCommentId=this.reply.id,this.$emit("addReply",e),this.showReplyForReplyFrom=!1}}};const Ge=(0,w.c)(qe,[["render",Re]]);var Xe=Ge,Ze={props:["data","power","pager"],components:{ReplyItem:Xe},data:function(){return{showPager:!1}},emits:["goto","resetReply","deleteReply","addNewReply"],methods:{showMore(){this.showPager=!0,this.$emit("goto",1)},showLess(){this.showPager=!1,this.$emit("resetReply")},handleCurrentChange(e){this.$emit("goto",e)},deleteReply(e){this.$emit("deleteReply",e)},addReply(e){this.$emit("addNewReply",e)}}};const et=(0,w.c)(Ze,[["render",xe]]);var tt=et,nt=n(28280),ot=n(26264);const at="cmt_order",{__Links:st,__next:it}=y;async function lt(){return O.c.isLogin()?(0,ot.ik)({mute:!0}).get("/api/cms/user/conf",{params:{key:at}}).then((e=>e.data.data)):new Promise((e=>{const t=localStorage.getItem(at)||"DESC";e(t)}))}async function rt(e){return O.c.isLogin()?(0,ot.ik)().put("/api/cms/user/conf",{val:e},{params:{key:at}}).then((e=>e.data.data)):new Promise((t=>{t(localStorage.setItem(at,e))}))}const mt=function(e,t){let n={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}};return ht(e,t,n)},ct={},dt=function(e,t,n){if(ct[e])if(Date.now()-ct[e].lastest<6e4){if(ct[e].count>=6)return nt.qG.warning({title:"系统",message:"你单身多久了? 动作这么快, 系统处理不过来 ( T_T )",duration:3e3,position:"bottom-right"}),new Promise(((e,t)=>{t()}));ct[e].count=ct[e].count+1}else Date.now()-ct[e].lastest>6e4&&(ct[e]={lastest:Date.now(),count:0});else ct[e]={lastest:Date.now(),count:0};let o={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)};return ht(e,t,o)},ut=function(e,t,n){let o={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)};return ht(e,t,o)},pt=function(e,t){let n={method:"DELETE"};return ht(e,t,n)};function ht(e,t,n){let o=it;if("/"==o[o.length-1]&&(o=o.substring(0,o.length-1)),e=o+e,n.credentials="include",t){let n=[];Object.keys(t).forEach((e=>{n.push(e+"="+t[e])}));let o=it;"/"==o[o.length-1]&&(o=o.substring(0,o.length-1)),e=e+"?"+n.join("&")}return fetch(e,n).then((e=>{switch(e.status){case 200:break;case 401:throw window.location.href=st.account.login+"?redirect="+encodeURIComponent(window.location.href),new Error("错误:"+e.statusText);case 403:throw window.location.href=st.account.login+"?redirect="+encodeURIComponent(window.location.href),new Error("错误:"+e.statusText);case 423:throw window.location.href=st.account.email_verify+"?redirect="+encodeURIComponent(window.location.href),new Error("错误:"+e.statusText);case 406:throw e.text().then((e=>{nt.qG.warning({title:"系统",message:e||"提交内容不合法,请重新提交",duration:3e3,position:"bottom-right"})})),new Error("错误:"+e.statusText);default:throw e.text().then((t=>{nt.qG.error({title:"系统:"+e.statusText,message:t||"系统错误,请稍后重试!",duration:3e3,position:"bottom-right"})})),new Error("错误:"+e.statusText)}let t=e.headers.get("Content-Type");switch(t=t&&t.split(";").shift(),t){case"application/json":return e.json();default:return e.text()}}))}var yt={props:["item","baseApi","power","user-href","username"],components:{CommentContent:Ee,ReplyList:tt},emits:["deleteComment","setTopComment","setStarComment","addNewReply","deleteReply","goto","resetReply"],data:function(){return{replyList:[],pager:{index:1,pageSize:10,pageTotal:1,total:0}}},created(){this.replyList=this.item.reply||[]},methods:{stringToArray:function(e){return e?JSON.parse(e):[]},deleteComment(){this.$emit("deleteComment",this.item.id)},setTopComment(e){this.$emit("setTopComment",this.item.id,e)},setStarComment(e){this.$emit("setStarComment",this.item.id,e)},addNewReply(e){dt(`${this.baseApi}/comment/${this.item.id}/reply`,null,e).then((()=>{this.$notify({title:"",message:"评论成功!",type:"success",duration:3e3,position:"bottom-right"}),this.loadReplyList(this.pager.index)})).catch((()=>{}))},deleteReply(e){pt(`${this.baseApi}/comment/${e}`).then((()=>{this.$notify({title:"",message:"删除成功!",type:"success",duration:3e3,position:"bottom-right"}),this.loadReplyList(this.pager.index)})).catch((()=>{}))},gotoReplyListIndex(e){this.loadReplyList(e,6)},loadReplyList(e,t){mt(`${this.baseApi}/comment/${this.item.id}/reply/page/${e}?pageSize=${t}`).then((n=>{1==e&&3==t&&(this.item.reply=n.data||[]),this.replyList=n.data||[],this.pager=n.page})).catch((()=>{}))},resetReply(){this.loadReplyList(1,3)}}};const gt=(0,w.c)(yt,[["render",se]]);var ft=gt,wt={name:"CommentComp",props:["id","category","normal","order"],components:{CommentAvatar:b,CommentWithReply:ft,CommentInputForm:Z},data:function(){return{baseAPI:"",commentPower:{allow:!1,uid:-1},commentList:[],pager:{index:1,pageSize:10,pageTotal:1,total:0},isDesc:"DESC",loading:!1}},computed:{isNormal:function(){return void 0===this.normal||this.normal}},methods:{changeOrder(){this.reloadCommentList(this.pager.index),rt(this.isDesc?"DESC":"ASC")},setTopComment(e,t){const n=t?"set":"cancel";ut(`${this.baseAPI}/comment/${e}/top/${n}`).then((()=>{this.reloadCommentList(this.pager.index)})).catch((()=>{}))},setStarComment(e,t){const n=t?"set":"cancel";ut(`${this.baseAPI}/comment/${e}/star/${n}`).then((()=>{this.reloadCommentList(this.pager.index)})).catch((()=>{}))},deleteComment(e){pt(`${this.baseAPI}/comment/${e}`).then((()=>{this.$notify({title:"",message:"删除成功!",type:"success",duration:3e3,position:"bottom-right"}),this.reloadCommentList(this.pager.index)})).catch((()=>{}))},reloadCommentList(e){this.loading=!0;let t={};"DESC"===this.isDesc&&(t["desc"]=!0),mt(`${this.baseAPI}/comment/page/${e}`,t).then((e=>{this.commentList=e.data||[],this.pager=e.page})).catch((()=>{})).finally((()=>{this.loading=!1}))},handleCurrentChange(e){this.reloadCommentList(e)},userSubmitInputForm(e){dt(`${this.baseAPI}/comment`,null,e).then((e=>{e&&~~e.code>0?this.$notify({title:"评论失败",message:e.msg||"",type:"error",duration:3e3,position:"bottom-right"}):(this.$notify({title:"",message:"评论成功!",type:"success",duration:3e3,position:"bottom-right"}),1==this.pager.index&&this.reloadCommentList(this.pager.index))})).catch((()=>{}))},profileLink:function(e){return(0,c.authorLink)(e)},showAvatar:function(e){return(0,c.showAvatar)(e,144)}},created(){this.baseAPI=`/api/next2/comment/${this.category}/article/${this.id}`},mounted(){lt().then((e=>{this.isDesc=e})).then((()=>{mt(`${this.baseAPI}/i-am-author`).then((e=>{this.commentPower=e})).catch((()=>{}))})).finally((()=>{this.reloadCommentList(1)}))}};const Ct=(0,w.c)(wt,[["render",m]]);var bt=Ct}}]);
//# sourceMappingURL=865.ac74ffb6.js.map