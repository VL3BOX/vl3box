"use strict";(self["webpackChunkpvp"]=self["webpackChunkpvp"]||[]).push([[773],{41123:function(e,t,n){n.d(t,{Z:function(){return Ct}});var o=n(66252);const a={class:"c-comment-order"},i=(0,o._)("span",{class:"u-label"},"排序模式：",-1),s={class:"c-comment-pages"},r={class:"u-pages"};function l(e,t,n,l,m,c){const u=(0,o.up)("CommentInputForm"),p=(0,o.up)("el-radio-button"),d=(0,o.up)("el-radio-group"),h=(0,o.up)("CommentAvatar"),g=(0,o.up)("CommentWithReply"),w=(0,o.up)("el-pagination"),y=(0,o.up)("el-main"),f=(0,o.up)("el-container"),k=(0,o.Q2)("loading");return(0,o.wy)(((0,o.wg)(),(0,o.j4)(f,{class:"c-comment"},{default:(0,o.w5)((()=>[(0,o.Wm)(y,null,{default:(0,o.w5)((()=>[(0,o.Wm)(u,{onSubmit:c.userSubmitInputForm},null,8,["onSubmit"]),(0,o._)("div",a,[i,(0,o.Wm)(d,{modelValue:e.isDesc,"onUpdate:modelValue":t[0]||(t[0]=t=>e.isDesc=t),onChange:c.changeOrder,size:"small"},{default:(0,o.w5)((()=>[(0,o.Wm)(p,{label:"DESC"},{default:(0,o.w5)((()=>[(0,o.Uk)("最后靠前")])),_:1}),(0,o.Wm)(p,{label:"ASC"},{default:(0,o.w5)((()=>[(0,o.Uk)("最早靠前")])),_:1})])),_:1},8,["modelValue","onChange"])]),c.isNormal?((0,o.wg)(),(0,o.iD)(o.HY,{key:0},[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(e.commentList,(t=>((0,o.wg)(),(0,o.iD)("div",{key:t.id,class:"c-comment-list"},[(0,o.Wm)(h,{"user-avatar":c.showAvatar(t.avatar),"user-href":c.profileLink(t.userId),username:t.displayName,avatarFrame:t.user_avatar_frame,withFrame:!0,avatarSize:48},null,8,["user-avatar","user-href","username","avatarFrame"]),(0,o.Wm)(g,{"base-api":e.baseAPI,item:t,category:n.category,power:e.commentPower,onDeleteComment:c.deleteComment,onSetTopComment:c.setTopComment,onSetStarComment:c.setStarComment,"user-href":c.profileLink(t.userId),username:t.displayName},null,8,["base-api","item","category","power","onDeleteComment","onSetTopComment","onSetStarComment","user-href","username"])])))),128)),(0,o._)("div",s,[e.commentList.length>5?((0,o.wg)(),(0,o.j4)(u,{key:0,onSubmit:c.userSubmitInputForm,isBottom:e.commentList.length>5},null,8,["onSubmit","isBottom"])):(0,o.kq)("",!0),(0,o._)("div",r,[(0,o.Wm)(w,{style:{"text-align":"right"},background:"","hide-on-single-page":"",onCurrentChange:c.handleCurrentChange,"current-page":e.pager.index,"page-size":e.pager.pageSize,layout:"prev, pager, next, total",total:e.pager.total},null,8,["onCurrentChange","current-page","page-size","total"])])])],64)):(0,o.kq)("",!0)])),_:1})])),_:1})),[[k,e.loading]])}var m=n(17233),c=n(3577);const u={class:"c-comment-avatar"},p=["href"],d=["src"];function h(e,t,n,a,i,s){const r=(0,o.up)("el-avatar"),l=(0,o.up)("el-link");return(0,o.wg)(),(0,o.iD)("div",u,[(0,o._)("a",{class:"u-avatar",href:n.userHref,target:"_blank"},[(0,o.Wm)(r,{class:(0,c.C_)(["u-avatar-pic",36==n.avatarSize?"xxs":""]),shape:"circle",size:n.avatarSize,src:n.userAvatar},null,8,["class","size","src"]),n.avatarFrame?((0,o.wg)(),(0,o.iD)("i",{key:0,class:(0,c.C_)(["u-avatar-frame",36==n.avatarSize?"xxs":"xs"])},[(0,o._)("img",{src:s.frameUrl},null,8,d)],2)):(0,o.kq)("",!0)],8,p),(0,o.Wm)(l,{class:"u-name",type:"primary",target:"_blank",href:n.userHref},{default:(0,o.w5)((()=>[(0,o.Uk)((0,c.zw)(n.username),1)])),_:1},8,["href"])])}var g=n(89847);const{__imgPath:w}=g;var y={name:"CommentAvatar",props:["avatarSize","userAvatar","userHref","username","avatarFrame","withFrame"],data:function(){return{}},computed:{frameUrl:function(){return w+`avatar/images/${this.avatarFrame}/${this.avatarFrame}.svg`}},methods:{},mounted:function(){}},f=n(83744);const k=(0,f.Z)(y,[["render",h]]);var C=k;const b={class:"c-comment-tools"},_={class:"u-toolbar"};function v(e,t,n,a,i,s){const r=(0,o.up)("el-input"),l=(0,o.up)("Picture"),m=(0,o.up)("el-icon"),c=(0,o.up)("Emotion"),u=(0,o.up)("Uploader"),p=(0,o.up)("el-button"),d=(0,o.up)("el-form-item"),h=(0,o.up)("el-form");return(0,o.wg)(),(0,o.j4)(h,{ref:"form",model:e.newComment,class:"c-comment-box"},{default:(0,o.w5)((()=>[(0,o.Wm)(d,null,{default:(0,o.w5)((()=>[(0,o.Wm)(r,{rows:"3",type:"textarea",maxlength:"300","show-word-limit":"",modelValue:e.newComment.content,"onUpdate:modelValue":t[0]||(t[0]=t=>e.newComment.content=t),placeholder:"参与讨论...",id:e.inputId},null,8,["modelValue","id"]),(0,o._)("div",b,[(0,o.Wm)(m,{class:"u-upload-icon",onClick:t[1]||(t[1]=t=>e.showUploader=!e.showUploader)},{default:(0,o.w5)((()=>[(0,o.Wm)(l)])),_:1}),(0,o.Wm)(c,{class:"c-comment-emotion",onSelected:s.handleEmotionSelected,type:"pop",max:6},null,8,["onSelected"])]),e.showUploader?((0,o.wg)(),(0,o.j4)(u,{key:0,class:"u-uploader",ref:"uploader",onOnFinish:s.attachmentUploadFinish,onOnError:s.attachmentUploadError},null,8,["onOnFinish","onOnError"])):(0,o.kq)("",!0),(0,o._)("div",_,[(0,o.Wm)(p,{type:"primary",onClick:s.onSubmit,class:"u-publish",disabled:e.disableSubmitBtn},{default:(0,o.w5)((()=>[(0,o.Uk)("发表评论")])),_:1},8,["onClick","disabled"])])])),_:1})])),_:1},8,["model"])}const S={class:"el-upload__tip"},x=["src"];function $(e,t,n,a,i,s){const r=(0,o.up)("Plus"),l=(0,o.up)("el-icon"),m=(0,o.up)("el-upload"),u=(0,o.up)("el-dialog");return(0,o.wg)(),(0,o.iD)("div",null,[(0,o.Wm)(m,{action:"https://cms.jx3box.com/api/cms/upload",ref:"upload","list-type":"picture-card","on-preview":s.handlePictureCardPreview,"auto-upload":!1,"file-list":i.fileList,limit:i.maxCount,accept:i.acceptedExtensions.reduce(((e,t)=>e+`.${t},`),""),multiple:"","with-credentials":"","on-exceed":s.onExceed,"on-change":s.onChange,"on-success":s.onSuccess,"on-error":s.onError},{tip:(0,o.w5)((()=>[(0,o._)("div",S," 最多上传 "+(0,c.zw)(i.maxCount)+" 张 "+(0,c.zw)(i.acceptedExtensions.join(" / ").toUpperCase())+" 格式图片，单张图片不能超过 "+(0,c.zw)(i.maxSize/1024/1024)+" MB ",1)])),default:(0,o.w5)((()=>[(0,o.Wm)(l,null,{default:(0,o.w5)((()=>[(0,o.Wm)(r)])),_:1})])),_:1},8,["on-preview","file-list","limit","accept","on-exceed","on-change","on-success","on-error"]),(0,o.Wm)(u,{modelValue:i.dialogVisible,"onUpdate:modelValue":t[0]||(t[0]=e=>i.dialogVisible=e)},{default:(0,o.w5)((()=>[(0,o._)("img",{width:"60%",src:i.dialogImageUrl,alt:""},null,8,x)])),_:1},8,["modelValue"])])}var R={name:"CommentUploader",data(){return{dialogImageUrl:"",dialogVisible:!1,fileList:[],successList:[],acceptedExtensions:["jpg","jpeg","png","gif"],maxCount:5,maxSize:2097152}},emits:["onFinish","onError"],methods:{handlePictureCardPreview(e){this.dialogImageUrl=e.url,this.dialogVisible=!0},onExceed(){this.$notify({title:"",message:`最多上传 ${this.maxCount} 张图片！`,type:"error",duration:3e3,position:"bottom-right"})},onChange(e,t){"ready"==e.status&&(e.size>this.maxSize?(this.$notify({title:"",message:`单张图片大小不能超过 ${this.maxSize/1024/1024} MB！`,type:"error",duration:3e3,position:"bottom-right"}),t.pop()):this.fileList=t)},upload(){this.fileList.length>0?this.$refs.upload.submit():this.$emit("onFinish",[])},onSuccess(e){this.successList=this.successList.concat(e.data),this.successList.length==this.fileList.length&&(this.$emit("onFinish",this.successList||[]),this.fileList=[],this.successList=[])},onError(){this.$notify({title:"",message:"图片上传失败!",type:"error",duration:3e3,position:"bottom-right"}),this.$emit("onError"),this.fileList=[]}}};const U=(0,f.Z)(R,[["render",$]]);var L=U,I=n.p+"img/emotion.08adf9c0.svg";const F={class:"c-jx3box-emotion"},D=["onClick"],j=["src","alt","title"],E={class:"c-jx3box-emotion-pop__content"},P=(0,o._)("div",{class:"u-title"},"表情",-1),W=["src","alt","title"],T={class:"c-jx3box-emotion-list"},z=["onClick"],A=["src","alt","title"],q=(0,o._)("img",{slot:"reference",class:"u-reference",width:"24",height:"24",src:I,alt:""},null,-1);function B(e,t,n,a,i,s){const r=(0,o.up)("el-tab-pane"),l=(0,o.up)("el-tabs"),m=(0,o.up)("Close"),c=(0,o.up)("el-icon"),u=(0,o.up)("el-popover");return(0,o.wg)(),(0,o.iD)("div",F,["default"===n.type?((0,o.wg)(),(0,o.j4)(l,{key:0,type:"card"},{default:(0,o.w5)((()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(s.decorationEmotion,(e=>((0,o.wg)(),(0,o.j4)(r,{key:e.group_id,label:e.group_name},{default:(0,o.w5)((()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(e.items,(e=>((0,o.wg)(),(0,o.iD)("span",{key:e.emotion_id,class:"c-jx3box-emotion-item",onClick:t=>s.handleEmotionClick(e)},[(0,o._)("img",{src:`${i.EmojiPath}${e.filename}`,alt:e.key,title:e.key},null,8,j)],8,D)))),128))])),_:2},1032,["label"])))),128))])),_:1})):((0,o.wg)(),(0,o.j4)(u,{key:1,placement:"top",trigger:"click","visible-arrow":!1,"popper-class":"c-jx3box-emotion-pop",ref:"emotion"},{reference:(0,o.w5)((()=>[q])),default:(0,o.w5)((()=>[(0,o._)("div",E,[(0,o.Wm)(c,{class:"u-close",onClick:s.closePop},{default:(0,o.w5)((()=>[(0,o.Wm)(m)])),_:1},8,["onClick"]),P,(0,o.Wm)(l,{class:"u-tabs",type:"card","tab-position":"bottom",size:"small"},{default:(0,o.w5)((()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(s.decorationEmotion,(e=>((0,o.wg)(),(0,o.j4)(r,{key:e.group_id,label:e.group_name},{label:(0,o.w5)((()=>[(0,o._)("img",{src:`${i.EmojiPath}${e.items[0].filename}`,alt:e.items[0].key,title:e.group_name,class:"u-tab-label"},null,8,W)])),default:(0,o.w5)((()=>[(0,o._)("div",T,[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(e.items,(e=>((0,o.wg)(),(0,o.iD)("span",{key:e.emotion_id,class:"c-jx3box-emotion-item",onClick:t=>s.handleEmotionClick(e)},[(0,o._)("img",{src:`${i.EmojiPath}${e.filename}`,alt:e.key,title:e.key},null,8,A)],8,z)))),128))])])),_:2},1032,["label"])))),128))])),_:1})])])),_:1},512))])}var N=n(5121);const{__cms:H}=g,O=e=>{const t=e&&e.domain||H;let n={withCredentials:!0,auth:{username:localStorage&&localStorage.getItem("token")||"",password:"cms common request"},baseURL:t,headers:{}};const o=N.Z.create(n);return o};var V=n(49e3);const{__imgPath:M,__dataPath:Z}=g;var Y={name:"Emotion",props:{type:{type:String,default:"default"},max:{type:Number,default:4}},emits:["selected"],data(){return{emotionList:[],EmojiPath:M+"emotion/output/",decoration:[]}},created(){this.loadEmotionList(),this.loadDecoration()},computed:{decorationEmotion({emotionList:e,decoration:t}){const n=e.filter((e=>0===e.group_id));if(0===t.length)return n;{const o=e.filter((e=>t.includes(e.group_name)));return[...n,...o].slice(0,this.max)}}},methods:{handleEmotionClick(e){this.$emit("selected",e),this.closePop()},loadEmotionList(){try{const e=sessionStorage.getItem("jx3_emotion");if(e)return void(this.emotionList=JSON.parse(e));fetch(`${Z}emotion/output/catalog.json`).then((e=>e.json())).then((e=>{this.emotionList=e,sessionStorage.setItem("jx3_emotion",JSON.stringify(e))}))}catch(e){fetch(`${Z}emotion/output/catalog.json`).then((e=>e.json())).then((e=>{this.emotionList=e,sessionStorage.setItem("jx3_emotion",JSON.stringify(e))}))}},loadDecoration(){V.Z.isLogin()&&O().get("/api/cms/user/decoration",{params:{type:"emotion",using:1}}).then((e=>{this.decoration=e.data?.data?.map((e=>e?.val))}))},closePop(){this.$refs.emotion&&this.$refs.emotion.hide()}}};const J=(0,f.Z)(Y,[["render",B]]);var K=J,G={components:{Uploader:L,Emotion:K},props:{isBottom:{type:Boolean,default:!1}},mounted(){this.isBottom&&(this.inputId="textarea-bottom")},data:function(){return{showUploader:!1,disableSubmitBtn:!1,newComment:{content:""},inputId:"textarea-top"}},methods:{onSubmit(){this.disableSubmitBtn=!0,this.$refs.uploader?this.$refs.uploader.upload():this.attachmentUploadFinish([])},attachmentUploadFinish(e){this.$emit("submit",{content:this.newComment.content,attachmentList:e}),this.newComment={content:""},this.showUploader=!1,this.disableSubmitBtn=!1},attachmentUploadError(){this.disableSubmitBtn=!1},handleEmotionSelected(e){this.insertVariable(e)},async insertVariable(e){const t=document.querySelector(`#${this.inputId}`),n=e.key;if(t.selectionStart||0===t.selectionStart){let e=t.selectionStart,o=t.selectionEnd;this.newComment.content=t.value.substring(0,e)+n+t.value.substring(o,t.value.length),await this.$nextTick(),t.focus(),t.setSelectionRange(o+n.length,o+n.length)}else this.newComment.content=n}}};const Q=(0,f.Z)(G,[["render",v]]);var X=Q;const ee={class:"c-comment-cmt"},te={key:0,class:"u-mark u-top"},ne=(0,o._)("i",{class:"Download"},null,-1),oe={key:1,class:"u-mark u-star"},ae=(0,o._)("i",{class:"Star"},null,-1);function ie(e,t,n,a,i,s){const r=(0,o.up)("el-link"),l=(0,o.up)("CommentContent"),m=(0,o.up)("ReplyList");return(0,o.wg)(),(0,o.iD)("div",ee,[(0,o._)("div",null,[(0,o.Wm)(r,{class:"u-name",type:"primary",target:"_blank",href:e.userHref},{default:(0,o.w5)((()=>[(0,o.Uk)((0,c.zw)(n.username||"人字榜800线无名小侠"),1)])),_:1},8,["href"]),n.item.is_top?((0,o.wg)(),(0,o.iD)("span",te,[ne,(0,o.Uk)("置顶")])):(0,o.kq)("",!0),n.item.is_star?((0,o.wg)(),(0,o.iD)("span",oe,[ae,(0,o.Uk)("精华")])):(0,o.kq)("",!0)]),(0,o.Wm)(l,{date:n.item.commentDate,content:n.item.content,"comment-id":n.item.id,attachments:s.stringToArray(n.item.attachments),"can-delete":n.power.allow||n.power.uid==n.item.userId,"can-set-top":n.power.is_author&&!n.item.is_top,"can-cancel-top":n.power.is_author&&n.item.is_top,"can-set-star":!n.item.is_star&&n.power.group>=64,"can-cancel-star":n.item.is_star&&n.power.group>=64,onAddNewReply:s.addNewReply,onDeleteComment:s.deleteComment,onSetTopComment:s.setTopComment,onSetStarComment:s.setStarComment},null,8,["date","content","comment-id","attachments","can-delete","can-set-top","can-cancel-top","can-set-star","can-cancel-star","onAddNewReply","onDeleteComment","onSetTopComment","onSetStarComment"]),(0,o.Wm)(m,{data:e.replyList,pager:e.pager,power:n.power,onAddNewReply:s.addNewReply,onDeleteReply:s.deleteReply,onGoto:s.gotoReplyListIndex,onResetReply:s.resetReply},null,8,["data","pager","power","onAddNewReply","onDeleteReply","onGoto","onResetReply"])])}const se={class:"u-cmt"},re=["innerHTML"],le={key:1,class:"u-attachements"},me={class:"u-toolbar"},ce={class:"u-date"},ue=(0,o._)("i",{class:"Clock"},null,-1),pe={class:"c-comment-tools"};function de(e,t,n,a,i,s){const r=(0,o.up)("el-image"),l=(0,o.up)("el-button"),m=(0,o.up)("el-input"),u=(0,o.up)("el-form-item"),p=(0,o.up)("Picture"),d=(0,o.up)("el-icon"),h=(0,o.up)("Emotion"),g=(0,o.up)("Uploader"),w=(0,o.up)("el-form");return(0,o.wg)(),(0,o.iD)("div",se,[""!=n.content?((0,o.wg)(),(0,o.iD)("div",{key:0,class:"u-text",innerHTML:s.formatContent(n.content)},null,8,re)):(0,o.kq)("",!0),n.attachments.length?((0,o.wg)(),(0,o.iD)("div",le,[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(n.attachments,(e=>((0,o.wg)(),(0,o.j4)(r,{key:e,src:s.showAttachment(e),"preview-src-list":[s.showPreview(e)],lazy:""},null,8,["src","preview-src-list"])))),128))])):(0,o.kq)("",!0),(0,o._)("div",me,[(0,o.Wm)(l,{class:"u-admin",link:"",size:"small",icon:"ChatRound",onClick:t[0]||(t[0]=t=>e.showForm=!e.showForm),type:"primary"},{default:(0,o.w5)((()=>[(0,o.Uk)("回复")])),_:1}),n.canDelete?((0,o.wg)(),(0,o.j4)(l,{key:0,class:"u-admin",link:"",icon:"Delete",size:"small",onClick:t[1]||(t[1]=e=>s.deleteComment()),type:"danger"},{default:(0,o.w5)((()=>[(0,o.Uk)("删除")])),_:1})):(0,o.kq)("",!0),n.canSetTop?((0,o.wg)(),(0,o.j4)(l,{key:1,class:"u-admin",link:"",icon:"Top",size:"small",onClick:t[2]||(t[2]=e=>s.topComment(!0)),type:"primary"},{default:(0,o.w5)((()=>[(0,o.Uk)("置顶")])),_:1})):(0,o.kq)("",!0),n.canCancelTop?((0,o.wg)(),(0,o.j4)(l,{key:2,class:"u-admin",link:"",icon:"Top",size:"small",onClick:t[3]||(t[3]=e=>s.topComment(!1)),type:"primary"},{default:(0,o.w5)((()=>[(0,o.Uk)("取消置顶")])),_:1})):(0,o.kq)("",!0),n.canSetStar?((0,o.wg)(),(0,o.j4)(l,{key:3,class:"u-admin",link:"",icon:"Star",size:"small",onClick:t[4]||(t[4]=e=>s.starComment(!0)),type:"primary"},{default:(0,o.w5)((()=>[(0,o.Uk)("加精")])),_:1})):(0,o.kq)("",!0),n.canCancelStar?((0,o.wg)(),(0,o.j4)(l,{key:4,class:"u-admin",link:"",icon:"StarFilled",size:"small",onClick:t[5]||(t[5]=e=>s.starComment(!1)),type:"primary"},{default:(0,o.w5)((()=>[(0,o.Uk)("取消加精")])),_:1})):(0,o.kq)("",!0),(0,o._)("time",ce,[ue,(0,o.Uk)(" "+(0,c.zw)(s.dataFormat(n.date)),1)])]),e.showForm?((0,o.wg)(),(0,o.j4)(w,{key:2,ref:"form",model:e.newComment,class:"c-comment-subbox"},{default:(0,o.w5)((()=>[(0,o.Wm)(u,null,{default:(0,o.w5)((()=>[(0,o.Wm)(m,{type:"textarea",modelValue:e.newComment.content,"onUpdate:modelValue":t[6]||(t[6]=t=>e.newComment.content=t),placeholder:"参与评论...",id:"id"+e.inputId},null,8,["modelValue","id"])])),_:1}),(0,o.Wm)(u,{class:"c-comment-tool-box"},{default:(0,o.w5)((()=>[(0,o._)("div",pe,[(0,o.Wm)(d,{class:"u-upload-icon",onClick:t[7]||(t[7]=t=>e.showUploader=!e.showUploader)},{default:(0,o.w5)((()=>[(0,o.Wm)(p)])),_:1}),(0,o.Wm)(h,{class:"c-comment-emotion",onSelected:s.handleEmotionSelected,type:"pop",max:6},null,8,["onSelected"])]),e.showUploader?((0,o.wg)(),(0,o.j4)(g,{key:0,ref:"uploader",onOnFinish:s.attachmentUploadFinish,onOnError:s.attachmentUplodError},null,8,["onOnFinish","onOnError"])):(0,o.kq)("",!0)])),_:1}),(0,o.Wm)(u,null,{default:(0,o.w5)((()=>[(0,o.Wm)(l,{size:"small",type:"primary",onClick:t[8]||(t[8]=e=>s.submit()),disabled:e.disableSubmitBtn},{default:(0,o.w5)((()=>[(0,o.Uk)("提交")])),_:1},8,["disabled"]),(0,o.Wm)(l,{size:"small",link:"",onClick:t[9]||(t[9]=t=>e.showForm=!1),type:"primary"},{default:(0,o.w5)((()=>[(0,o.Uk)("收起")])),_:1})])),_:1})])),_:1},8,["model"])):(0,o.kq)("",!0)])}var he=n(19755),ge=n.n(he),we=n(96486);const{__imgPath:ye,__dataPath:fe}=g;async function ke(){const e=sessionStorage.getItem("jx3_emotion");if(e)return JSON.parse(e);{const e=await fetch(`${fe}emotion/output/catalog.json`).then((e=>e.json()));return sessionStorage.setItem("jx3_emotion",JSON.stringify(e)),e}}class Ce{constructor(e){this._joke=ge().trim(e),this.emotionList=[],this.max=0}async loadEmotionList(){const e=await ke();this.emotionList=e}async _renderHTML(){let e=this._joke;if(!e.includes("#"))return e;for(let t=0;t<3;t++){await this.loadEmotionList();const t=(0,we.flatMapDeep)(this.emotionList.map((e=>e.items))),n=t.map((e=>e.key));while(n.some((t=>e.includes(t)))){const t=n.findIndex((t=>e.includes(t))),o=n[t].replace("#","$");e=t>-1?e.replace(n[t],o):e}while(n.some((t=>e.includes(`${t.replace("#","$")}`)))){const o=n.findIndex((t=>e.includes(t.replace("#","$")))),a=t.find((e=>e.key===n[o])),i=a?`${ye}emotion/output/${a.filename}`:"",s=n[o].replace("#","$");e=i?e.replace(s,`<img src="${i}" alt="${n[o]}" title="${n[o]}" />`):e}if(this.emotionList.length)break}return e}}var be=Ce;function _e(e){const t=new be(e);return t.code}function ve(e){return e>9?e:`0${e}`}var Se={props:["content","date","hasReply","canDelete","canSetTop","canCancelTop","canSetStar","canCancelStar","attachments","commentId"],components:{Uploader:L,Emotion:K},data:function(){return{newComment:{content:""},showForm:!1,disableSubmitBtn:!1,showUploader:!1,inputId:"",previewList:[]}},mounted(){this.commentId&&(this.inputId=this.commentId)},computed:{_attachments:function(){return this.attachments.map((e=>(0,m.resolveImagePath)(e)))}},methods:{topComment(e){this.$emit("setTopComment",e)},starComment(e){this.$emit("setStarComment",e)},deleteComment(){this.$confirm("确定删除该评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.$emit("deleteComment")})).catch((()=>{}))},dataFormat(e){let t=new Date(e);return t.getFullYear()+"-"+ve(t.getMonth()+1)+"-"+ve(t.getDate())+" "+ve(t.getHours())+":"+ve(t.getMinutes())+":"+ve(t.getSeconds())},attachmentUploadFinish(e){this.disableSubmitBtn=!1,this.$emit("addNewReply",{content:this.newComment.content,attachmentList:e}),this.showUploader=!1,this.newComment={content:""}},attachmentUplodError(){this.disableSubmitBtn=!1},submit(){this.disableSubmitBtn=!0,this.$refs.uploader?this.$refs.uploader.upload():this.attachmentUploadFinish([])},hideForm(){},formatContent:_e,async handleEmotionSelected(e){const t=document.querySelector(`#id${this.inputId}`),n=e.key;if(t.selectionStart||0===t.selectionStart){let e=t.selectionStart,o=t.selectionEnd;this.newComment.content=t.value.substring(0,e)+n+t.value.substring(o,t.value.length),await this.$nextTick(),t.focus(),t.setSelectionRange(o+n.length,o+n.length)}else this.newComment.content=n},showPreview:function(e){return(0,m.resolveImagePath)(e)},showAttachment:function(e){return(0,m.resolveImagePath)(e)+"?x-oss-process=style/comment_thumb"}}};const xe=(0,f.Z)(Se,[["render",de]]);var $e=xe,Re=n(49963);const Ue={key:0,class:"c-comment-replylist"};function Le(e,t,n,a,i,s){const r=(0,o.up)("reply-item"),l=(0,o.up)("el-button"),m=(0,o.up)("el-col"),c=(0,o.up)("el-pagination"),u=(0,o.up)("el-row");return n.data.length?((0,o.wg)(),(0,o.iD)("div",Ue,[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(n.data,(e=>((0,o.wg)(),(0,o.j4)(r,{class:"c-comment-reply",key:e.id,reply:e,power:n.power,onDeleteReply:s.deleteReply,onAddReply:s.addReply},null,8,["reply","power","onDeleteReply","onAddReply"])))),128)),n.data.length>=3||e.showPager?((0,o.wg)(),(0,o.j4)(u,{key:0},{default:(0,o.w5)((()=>[(0,o.Wm)(m,{span:4},{default:(0,o.w5)((()=>[(0,o.wy)((0,o.Wm)(l,{link:"",onClick:t[0]||(t[0]=e=>s.showLess())},{default:(0,o.w5)((()=>[(0,o.Uk)("收起")])),_:1},512),[[Re.F8,e.showPager]]),(0,o.wy)((0,o.Wm)(l,{link:"",onClick:t[1]||(t[1]=e=>s.showMore())},{default:(0,o.w5)((()=>[(0,o.Uk)("查看更多")])),_:1},512),[[Re.F8,!e.showPager]])])),_:1}),(0,o.Wm)(m,{span:20,class:"c-comment-reply-pages"},{default:(0,o.w5)((()=>[(0,o.wy)((0,o.Wm)(c,{small:"",onCurrentChange:s.handleCurrentChange,"current-page":n.pager.index,"page-size":n.pager.pageSize,layout:"total, prev, pager, next",total:n.pager.total},null,8,["onCurrentChange","current-page","page-size","total"]),[[Re.F8,e.showPager]])])),_:1})])),_:1})):(0,o.kq)("",!0)])):(0,o.kq)("",!0)}function Ie(e,t,n,a,i,s){const r=(0,o.up)("CommentAvatar"),l=(0,o.up)("CommentContentSimple"),m=(0,o.up)("ReplyForReply"),c=(0,o.up)("el-row");return(0,o.wg)(),(0,o.j4)(c,null,{default:(0,o.w5)((()=>[(0,o.Wm)(r,{"user-avatar":s.showAvatar(n.reply.avatar),"user-href":s.profileLink(n.reply.userId),username:n.reply.displayName,avatarFrame:n.reply.user_avatar_frame,avatarSize:36},null,8,["user-avatar","user-href","username","avatarFrame"]),(0,o.Wm)(l,{"comment-id":n.reply.id,date:n.reply.commentDate,content:n.reply.content,attachments:s.stringToArray(n.reply.attachments),"can-delete":n.power.allow||n.power.uid==n.reply.userId,"can-reply":n.power.uid!=n.reply.userId,"user-href":s.profileLink(n.reply.replyForUID),"reply-for-username":n.reply.replyForUsername,"reply-for-user-id":n.reply.replyForUID,onDelete:s.deleteReply,onShowReplyInput:t[0]||(t[0]=t=>e.showReplyForReplyFrom=!e.showReplyForReplyFrom)},null,8,["comment-id","date","content","attachments","can-delete","can-reply","user-href","reply-for-username","reply-for-user-id","onDelete"]),e.showReplyForReplyFrom?((0,o.wg)(),(0,o.j4)(m,{key:0,username:n.reply.displayName,"user-href":s.profileLink(n.reply.userId),"current-id":n.reply.id,onHideForm:t[1]||(t[1]=t=>e.showReplyForReplyFrom=!1),onDoReply:s.doReply},null,8,["username","user-href","current-id","onDoReply"])):(0,o.kq)("",!0)])),_:1})}const Fe={class:"u-reply"},De={class:"u-reply-content"},je={key:0,class:"u-reply-label"},Ee=["innerHTML"],Pe={key:0,class:"u-attachements"},We={class:"u-toolbar"},Te={class:"u-date"},ze=(0,o._)("i",{class:"Clock"},null,-1);function Ae(e,t,n,a,i,s){const r=(0,o.up)("el-link"),l=(0,o.up)("el-image"),m=(0,o.up)("el-button");return(0,o.wg)(),(0,o.iD)("div",Fe,[(0,o._)("div",De,[0!=n.replyForUserId?((0,o.wg)(),(0,o.iD)("span",je,[(0,o.Uk)(" 回复 "),(0,o.Wm)(r,{type:"primary",target:"_blank",href:n.userHref},{default:(0,o.w5)((()=>[(0,o.Uk)("@"+(0,c.zw)(n.replyForUsername),1)])),_:1},8,["href"]),(0,o.Uk)(" : ")])):(0,o.kq)("",!0),(0,o._)("div",{class:"u-reply-text",innerHTML:s.formatContent(n.content)},null,8,Ee)]),n.attachments.length?((0,o.wg)(),(0,o.iD)("div",Pe,[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(n.attachments,(e=>((0,o.wg)(),(0,o.j4)(l,{key:e,src:s.showAttachment(e),"preview-src-list":[s.showPreview(e)],lazy:""},null,8,["src","preview-src-list"])))),128))])):(0,o.kq)("",!0),(0,o._)("div",We,[n.canReply?((0,o.wg)(),(0,o.j4)(m,{key:0,class:"u-admin",link:"",icon:"ChatLineRound",size:"small",onClick:t[0]||(t[0]=e=>s.showReplyForReplyInput()),type:"primary"},{default:(0,o.w5)((()=>[(0,o.Uk)("回复")])),_:1})):(0,o.kq)("",!0),n.canDelete?((0,o.wg)(),(0,o.j4)(m,{key:1,class:"u-admin",link:"",icon:"Delete",size:"small",type:"danger",onClick:t[1]||(t[1]=e=>s.deleteComment())},{default:(0,o.w5)((()=>[(0,o.Uk)("删除")])),_:1})):(0,o.kq)("",!0),(0,o._)("time",Te,[ze,(0,o.Uk)(" "+(0,c.zw)(s.dataFormat(n.date)),1)])])])}function qe(e){return e>9?e:`0${e}`}var Be={props:["commentId","content","attachments","date","hasReply","canDelete","canReply","userHref","replyForUsername","replyForUserId"],data:function(){return{showInput:!1}},computed:{_attachments:function(){return this.attachments.map((e=>(0,m.resolveImagePath)(e)))}},methods:{profileLink:function(e){return(0,m.authorLink)(e)},showAttachment:function(e){return(0,m.resolveImagePath)(e)+"?x-oss-process=style/comment_thumb"},formatContent:_e,getPList(e){return e.split("\n")},deleteComment(){this.$confirm("确定删除该评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.$emit("delete",this.commentId)})).catch((()=>{}))},dataFormat(e){let t=new Date(e);return t.getFullYear()+"-"+qe(t.getMonth()+1)+"-"+qe(t.getDate())+" "+qe(t.getHours())+":"+qe(t.getMinutes())+":"+qe(t.getSeconds())},showReplyForReplyInput(){this.$emit("showReplyInput")},previewImg(e){this.$hevueImgPreview({multiple:!0,nowImgIndex:e,imgList:this._attachments,controlBar:!1,clickMaskCLose:!0})},showPreview:function(e){return(0,m.resolveImagePath)(e)}}};const Ne=(0,f.Z)(Be,[["render",Ae]]);var He=Ne;const Oe={class:"u-subbox-label"},Ve={class:"c-comment-tools"};function Me(e,t,n,a,i,s){const r=(0,o.up)("el-link"),l=(0,o.up)("el-input"),m=(0,o.up)("el-form-item"),u=(0,o.up)("Picture"),p=(0,o.up)("el-icon"),d=(0,o.up)("Uploader"),h=(0,o.up)("el-button"),g=(0,o.up)("el-form");return(0,o.wg)(),(0,o.j4)(g,{ref:"form",class:"c-comment-subbox"},{default:(0,o.w5)((()=>[(0,o._)("div",Oe,[(0,o.Uk)(" 回复 "),(0,o.Wm)(r,{type:"primary",target:"_blank",href:n.userHref},{default:(0,o.w5)((()=>[(0,o.Uk)("＠"+(0,c.zw)(n.username),1)])),_:1},8,["href"]),(0,o.Uk)(" ： ")]),(0,o.Wm)(m,null,{default:(0,o.w5)((()=>[(0,o.Wm)(l,{type:"textarea",modelValue:e.content,"onUpdate:modelValue":t[0]||(t[0]=t=>e.content=t),id:"id"+e.inputId,placeholder:"输入回复..."},null,8,["modelValue","id"])])),_:1}),(0,o.Wm)(m,null,{default:(0,o.w5)((()=>[(0,o._)("div",Ve,[(0,o.Wm)(p,{class:"u-upload-icon",onClick:t[1]||(t[1]=t=>e.showUploader=!e.showUploader)},{default:(0,o.w5)((()=>[(0,o.Wm)(u)])),_:1})]),e.showUploader?((0,o.wg)(),(0,o.j4)(d,{key:0,ref:"uploader",onOnFinish:s.attachmentUploadFinish,onOnError:s.attachmentUploadError},null,8,["onOnFinish","onOnError"])):(0,o.kq)("",!0)])),_:1}),(0,o.Wm)(m,null,{default:(0,o.w5)((()=>[(0,o.Wm)(h,{size:"small",type:"primary",onClick:s.submitReply,disabled:e.disableSubmitBtn},{default:(0,o.w5)((()=>[(0,o.Uk)("提交")])),_:1},8,["onClick","disabled"]),(0,o.Wm)(h,{size:"small",link:"",onClick:t[2]||(t[2]=e=>s.hideForm())},{default:(0,o.w5)((()=>[(0,o.Uk)("收起")])),_:1})])),_:1})])),_:1},512)}var Ze={props:["username","userHref","currentId"],data:function(){return{content:"",showUploader:!1,disableSubmitBtn:!1,inputId:""}},components:{Uploader:L},mounted(){this.currentId&&(this.inputId=this.currentId)},methods:{submitReply(){this.disableSubmitBtn=!0,this.$refs.uploader?this.$refs.uploader.upload():this.attachmentUploadFinish([])},hideForm(){this.$emit("hideForm")},attachmentUploadFinish(e){this.disableSubmitBtn=!1,this.$emit("doReply",{content:this.content,attachmentList:e}),this.content="",this.showUploader=!1},attachmentUploadError(){this.disableSubmitBtn=!1},async handleEmotionSelected(e){const t=document.querySelector(`#id${this.inputId}`),n=e.key;if(t.selectionStart||0===t.selectionStart){let e=t.selectionStart,o=t.selectionEnd;this.content=t.value.substring(0,e)+n+t.value.substring(o,t.value.length),await this.$nextTick(),t.focus(),t.setSelectionRange(o+n.length,o+n.length)}else this.content=n}}};const Ye=(0,f.Z)(Ze,[["render",Me]]);var Je=Ye,Ke={props:["reply","power"],components:{CommentAvatar:C,CommentContentSimple:He,ReplyForReply:Je},backReplyList:[],data:function(){return{showReplyForReplyFrom:!1}},methods:{profileLink:function(e){return(0,m.authorLink)(e)},stringToArray:function(e){return e?JSON.parse(e):[]},showAvatar:function(e){return(0,m.showAvatar)(e,84)},deleteReply(e){this.$emit("deleteReply",e)},doReply(e){e.replyForUID=this.reply.userId,e.replyForCommentId=this.reply.id,this.$emit("addReply",e),this.showReplyForReplyFrom=!1}}};const Ge=(0,f.Z)(Ke,[["render",Ie]]);var Qe=Ge,Xe={props:["data","power","pager"],components:{ReplyItem:Qe},data:function(){return{showPager:!1}},emits:["goto","resetReply","deleteReply","addNewReply"],methods:{showMore(){this.showPager=!0,this.$emit("goto",1)},showLess(){this.showPager=!1,this.$emit("resetReply")},handleCurrentChange(e){this.$emit("goto",e)},deleteReply(e){this.$emit("deleteReply",e)},addReply(e){this.$emit("addNewReply",e)}}};const et=(0,f.Z)(Xe,[["render",Le]]);var tt=et,nt=n(49996),ot=n(18371);const at="cmt_order",{__Links:it,__next:st}=g;async function rt(){return V.Z.isLogin()?(0,ot.nj)({mute:!0}).get("/api/cms/user/conf",{params:{key:at}}).then((e=>e.data.data)):new Promise((e=>{const t=localStorage.getItem(at)||"DESC";e(t)}))}async function lt(e){return V.Z.isLogin()?(0,ot.nj)().put("/api/cms/user/conf",{val:e},{params:{key:at}}).then((e=>e.data.data)):new Promise((t=>{t(localStorage.setItem(at,e))}))}const mt=function(e,t){let n={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}};return ht(e,t,n)},ct={},ut=function(e,t,n){if(ct[e])if(Date.now()-ct[e].lastest<6e4){if(ct[e].count>=6)return nt.bM.warning({title:"系统",message:"你单身多久了? 动作这么快, 系统处理不过来 ( T_T )",duration:3e3,position:"bottom-right"}),new Promise(((e,t)=>{t()}));ct[e].count=ct[e].count+1}else Date.now()-ct[e].lastest>6e4&&(ct[e]={lastest:Date.now(),count:0});else ct[e]={lastest:Date.now(),count:0};let o={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)};return ht(e,t,o)},pt=function(e,t,n){let o={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)};return ht(e,t,o)},dt=function(e,t){let n={method:"DELETE"};return ht(e,t,n)};function ht(e,t,n){let o=st;if("/"==o[o.length-1]&&(o=o.substring(0,o.length-1)),e=o+e,n.credentials="include",t){let n=[];Object.keys(t).forEach((e=>{n.push(e+"="+t[e])}));let o=st;"/"==o[o.length-1]&&(o=o.substring(0,o.length-1)),e=e+"?"+n.join("&")}return fetch(e,n).then((e=>{switch(e.status){case 200:break;case 401:throw window.location.href=it.account.login+"?redirect="+encodeURIComponent(window.location.href),new Error("错误:"+e.statusText);case 403:throw window.location.href=it.account.login+"?redirect="+encodeURIComponent(window.location.href),new Error("错误:"+e.statusText);case 423:throw window.location.href=it.account.email_verify+"?redirect="+encodeURIComponent(window.location.href),new Error("错误:"+e.statusText);case 406:throw e.text().then((e=>{nt.bM.warning({title:"系统",message:e||"提交内容不合法,请重新提交",duration:3e3,position:"bottom-right"})})),new Error("错误:"+e.statusText);default:throw e.text().then((t=>{nt.bM.error({title:"系统:"+e.statusText,message:t||"系统错误,请稍后重试!",duration:3e3,position:"bottom-right"})})),new Error("错误:"+e.statusText)}let t=e.headers.get("Content-Type");switch(t=t&&t.split(";").shift(),t){case"application/json":return e.json();default:return e.text()}}))}var gt={props:["item","baseApi","power","user-href","username"],components:{CommentContent:$e,ReplyList:tt},emits:["deleteComment","setTopComment","setStarComment","addNewReply","deleteReply","goto","resetReply"],data:function(){return{replyList:[],pager:{index:1,pageSize:10,pageTotal:1,total:0}}},created(){this.replyList=this.item.reply||[]},methods:{stringToArray:function(e){return e?JSON.parse(e):[]},deleteComment(){this.$emit("deleteComment",this.item.id)},setTopComment(e){this.$emit("setTopComment",this.item.id,e)},setStarComment(e){this.$emit("setStarComment",this.item.id,e)},addNewReply(e){ut(`${this.baseApi}/comment/${this.item.id}/reply`,null,e).then((()=>{this.$notify({title:"",message:"评论成功!",type:"success",duration:3e3,position:"bottom-right"}),this.loadReplyList(this.pager.index)})).catch((()=>{}))},deleteReply(e){dt(`${this.baseApi}/comment/${e}`).then((()=>{this.$notify({title:"",message:"删除成功!",type:"success",duration:3e3,position:"bottom-right"}),this.loadReplyList(this.pager.index)})).catch((()=>{}))},gotoReplyListIndex(e){this.loadReplyList(e,6)},loadReplyList(e,t){mt(`${this.baseApi}/comment/${this.item.id}/reply/page/${e}?pageSize=${t}`).then((n=>{1==e&&3==t&&(this.item.reply=n.data||[]),this.replyList=n.data||[],this.pager=n.page})).catch((()=>{}))},resetReply(){this.loadReplyList(1,3)}}};const wt=(0,f.Z)(gt,[["render",ie]]);var yt=wt,ft={name:"CommentComp",props:["id","category","normal","order"],components:{CommentAvatar:C,CommentWithReply:yt,CommentInputForm:X},data:function(){return{baseAPI:"",commentPower:{allow:!1,uid:-1},commentList:[],pager:{index:1,pageSize:10,pageTotal:1,total:0},isDesc:"DESC",loading:!1}},computed:{isNormal:function(){return void 0===this.normal||this.normal}},methods:{changeOrder(){this.reloadCommentList(this.pager.index),lt(this.isDesc?"DESC":"ASC")},setTopComment(e,t){const n=t?"set":"cancel";pt(`${this.baseAPI}/comment/${e}/top/${n}`).then((()=>{this.reloadCommentList(this.pager.index)})).catch((()=>{}))},setStarComment(e,t){const n=t?"set":"cancel";pt(`${this.baseAPI}/comment/${e}/star/${n}`).then((()=>{this.reloadCommentList(this.pager.index)})).catch((()=>{}))},deleteComment(e){dt(`${this.baseAPI}/comment/${e}`).then((()=>{this.$notify({title:"",message:"删除成功!",type:"success",duration:3e3,position:"bottom-right"}),this.reloadCommentList(this.pager.index)})).catch((()=>{}))},reloadCommentList(e){this.loading=!0;let t={};"DESC"===this.isDesc&&(t["desc"]=!0),mt(`${this.baseAPI}/comment/page/${e}`,t).then((e=>{this.commentList=e.data||[],this.pager=e.page})).catch((()=>{})).finally((()=>{this.loading=!1}))},handleCurrentChange(e){this.reloadCommentList(e)},userSubmitInputForm(e){ut(`${this.baseAPI}/comment`,null,e).then((e=>{e&&~~e.code>0?this.$notify({title:"评论失败",message:e.msg||"",type:"error",duration:3e3,position:"bottom-right"}):(this.$notify({title:"",message:"评论成功!",type:"success",duration:3e3,position:"bottom-right"}),1==this.pager.index&&this.reloadCommentList(this.pager.index))})).catch((()=>{}))},profileLink:function(e){return(0,m.authorLink)(e)},showAvatar:function(e){return(0,m.showAvatar)(e,144)}},created(){this.baseAPI=`/api/next2/comment/${this.category}/article/${this.id}`},mounted(){rt().then((e=>{this.isDesc=e})).then((()=>{mt(`${this.baseAPI}/i-am-author`).then((e=>{this.commentPower=e})).catch((()=>{}))})).finally((()=>{this.reloadCommentList(1)}))}};const kt=(0,f.Z)(ft,[["render",l]]);var Ct=kt}}]);
//# sourceMappingURL=773.1438368c.js.map